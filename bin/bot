#!/usr/bin/env bash
set -euo pipefail
IFS=$'\n\t'

# --- Setup ---
SCRIPT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" &> /dev/null && pwd )"
source "${SCRIPT_DIR}/../lib/includes.sh"

# --- Help ---
usage() {
  log_msg "Usage:"
  log_msg "  bot co <branch-description>          # create & checkout from '${BASE_BRANCH}'"
  log_msg "  bot ci -m \"message\"                  # commit with update from '${BASE_BRANCH}'"
  log_msg "  bot wip -m \"message\"                 # same as ci but appends -WIP"
  log_msg "  bot pull [branch]                    # merge latest from origin/<branch>"
  log_msg "  bot rebase [branch]                  # rebase onto origin/<branch>"
  log_msg "  bot squash <n>                       # interactive squash of last n commits"
  log_msg "  bot amend                            # amend last commit"
  log_msg "  bot rename <new-branch>              # rename branch"
  log_msg "  bot undo                             # undo last commit (keep staged)"
  log_msg "  bot status                           # show git status summary"
  log_msg "  bot help                             # show usage information"
}

# --- Arg parse ---
[ $# -lt 1 ] && { usage; exit 1; }

COMMAND="$1"; shift || true

# --- Command Handlers ---
case "$COMMAND" in
    ci|wip)
        create_commit "$COMMAND" "${@}"
        ;;

    co)
        create_branch "${@}"
        ;;

    pull)
        pull_from_remote "${1}"
        ;;

    rebase)
        rebase_from_remote "${1}"
        ;;

    squash)
        squash_commits $1
        ;;

    amend)
        amend_commit
        ;;

    rename)
        rename_branch "$1"
        ;;

    undo)
        undo_last_commit
        ;;

    status)
        print_branch_status
        ;;
    
    help)
        usage
        ;;

    *)
        usage
        log_error "Unknown command: $COMMAND"
        ;;
esac

exit 0
